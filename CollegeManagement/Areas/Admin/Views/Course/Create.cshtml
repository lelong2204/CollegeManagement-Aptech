@model CourseUpSertDTO

@{
    ViewData["Title"] = "Create";
}

<h1>Create</h1>

<h4>Course</h4>
<hr />
<div class="row">
    <div class="col-md-6">
        <form asp-action="Create" id="course_form" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Info" class="control-label">
                    Information
                </label>
                <input asp-for="Info" class="form-control" />
                <span asp-validation-for="Info" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Price" class="control-label"></label>
                <input asp-for="Price" class="form-control" />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
            <div class="form-group form-switch" style="padding: 0">
                <label asp-for="Focus" class="form-check-label" for="flexSwitchCheckChecked"></label>
                <input asp-for="Focus" class="form-check-input" style="float:right" type="checkbox" id="flexSwitchCheckChecked" checked>
                <span asp-validation-for="Focus" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="DepartmentID" class="control-label">Department</label>
                <select asp-for="DepartmentID" class="select2 form-control">
                    @foreach (var department in Model.DepartmentList)
                    {
                        <option value="@department.ID">@department.Name</option>
                    }
                </select>
                <span asp-validation-for="DepartmentID" class="text-danger"></span>
            </div>
            <label>Add Subject</label>
            <table class="row table table-hover">
                <tbody id="course_subject" class="col-12">
                </tbody>
            </table>
            <span id="subject_error" class="text-danger col-12"></span>
            <button type="button" id="add_subject" class="btn btn-primary mb-2 col-12">Add Subject</button>
            <div class="form-group">
                <label asp-for="Image" class="control-label"></label>
                <button type="button" class="btn btn-info" id="img-select-btn">Choose Image...</button>
                <input asp-for="Image" type="file" class="form-control" id="image-select" hidden accept="image/*" />
            </div>
            <div class="form-group">
                <img class="upload-img" />
            </div>
            <div class="form-group">
                <button id="btn_create" class="btn btn-success mr-2" type="button">Create</button>
                <a asp-action="Index" class="btn btn-secondary">Back to List</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>var subjectIndex = 0;
        var subjectData = [];
        var subjectList = [];
        var facultyList = [];

        $(document).ready(function () {

            $('#add_subject').on('click', function (e) {
                $("#subject_error").text("")

                subjectData.push({ subjectID: null, facultyID: null });
                subjectList.push(null);
                facultyList.push(null);

                $('#course_subject').append(`
                    <tr class="row" data-index="${subjectIndex}">
                        <td class="col-md-5">
                            <div class="form-group">
                                <label class="control-label">Subject</label>
                                <select class="select2 form-control subject_select subject_${subjectIndex}" data-index="${subjectIndex}">
                                </select>
                                <span id='error_subject_${subjectIndex}' class="text-danger"></span>
                            </div>
                        </td>
                        <td class="col-md-5">
                            <div class="form-group">
                                <label class="control-label">Faculty</label>
                                <select class="select2 form-control faculty_select faculty_${subjectIndex}" data-index="${subjectIndex}">
                                </select>
                            </div>
                        </td>
                        <td class="col-md-2" style="display: flex; align-items:center">
                            <button type="button" data-index="${subjectIndex}" class="btn btn-danger remove-subject">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>`);

                $(`.subject_${subjectIndex}`).select2({
                    ajax: {
                        url: '/Admin/Subject/Select2',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            var query = {
                                search: params.term,
                                facultyID: facultyList[$(this).data('index')],
                                subjectExist: JSON.stringify(subjectList)
                            }
                            return query;
                        },
                        processResults: function (data) {
                            return {
                                results: $.map(data, function (obj) {
                                    return { id: obj.id, text: obj.name };
                                })
                            };
                        }
                    },
                    allowClear: true, placeholder: "Select subject"
                }).on('change', function () {
                    var index = $(this).data('index');
                    $(`#error_subject_${index}`).text("");
                    subjectList[index] = $(this).val();
                    subjectData[index].subjectID = $(this).val();
                });

                $(`.faculty_${subjectIndex}`).select2({
                    ajax: {
                        url: '/Admin/Faculty/Select2',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            var query = {
                                search: params.term,
                                subjectID: subjectList[$(this).data('index')],
                                facultyExist: JSON.stringify(facultyList)
                            }
                            return query;
                        },
                        processResults: function (data) {
                            return {
                                results: $.map(data, function (obj) {
                                    return { id: obj.id, text: obj.name };
                                })
                            };
                        }
                    },
                    allowClear: true, placeholder: "Select faculty"
                }).on('change', function () {
                    var index = $(this).data('index');
                    facultyList[index] = $(this).val();
                    subjectData[index].facultyID = $(this).val();
                });

                subjectIndex++;
            })

            $('#add_subject').trigger('click');

            $('#btn_create').on('click', function () {
                var subjects = [];
                var isValid = true;
                $.each(subjectData, function (i, data) {
                    if (data !== undefined && data) {
                        if (data.subjectID === undefined || !data.subjectID) {
                            isValid = false;
                            $(`#error_subject_${i}`).text("This field is required");

                        } else {
                            subjects.push({
                                'SubjectID': data.subjectID,
                                'FacultyID': data.facultyID
                            })

                            $(`#error_subject_${i}`).text("");
                        }
                    }
                });

                if (!isValid) return;

                $.validator.unobtrusive.parse($('#course_form'));
                console.log($('#course_form').valid());
                if (!$('#course_form').valid()) {
                    return;
                }

                var form = $('#course_form').serializeArray();
                form.push({ name: "Subjects", value: JSON.stringify(subjects) });

                $.ajax({
                    url: "/Admin/Course/Create",
                    method: "POST",
                    data: form,
                    success: function (res) {
                        console.log(res);
                    }
                })
            });
        })

        $(document).on('click', '.remove-subject', function () {
            if ($('#course_subject').find('tr').length === 1) {
                $("#subject_error").text("Need at least one subject")
                return;
            }

            var index = $(this).data('index');
            $('#course_subject').find(`tr[data-index='${index}']`).remove();
            facultyList[index] = null;
            subjectList[index] = null;
            subjectData[index] = null;
        })</script>
}